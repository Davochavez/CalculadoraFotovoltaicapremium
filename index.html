<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Solar - Calculadora Fotovoltaica con IA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-foreground: #ffffff;
            --secondary: #00c8a0;
            --secondary-foreground: #ffffff;
            --primary-dark: #0a0a18;
            --primary-bg: #121230;
            --card-bg: #1a1a42;
            --accent-purple: var(--primary);
            --accent-blue: var(--secondary);
            --accent-magenta: #fd5af7;
            --accent-cyan: #5afdf7;
            --text-color: #e0e0ff;
            --footer-text: rgba(224, 224, 255, 0.6);
            --border-color: rgba(37, 99, 235, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --result-bg: rgba(26, 26, 66, 0.6);
        }

        [data-theme="light"] {
            --primary-dark: #f0f4ff;
            --primary-bg: #e6f0ff;
            --card-bg: #ffffff;
            --accent-purple: #5b21b6;
            --accent-blue: #047857;
            --accent-magenta: #c026d3;
            --accent-cyan: #0d9488;
            --text-color: #1a1a42;
            --footer-text: rgba(26, 26, 66, 0.7);
            --border-color: rgba(37, 99, 235, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --result-bg: rgba(240, 244, 255, 0.8);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at top, var(--primary-dark), var(--primary-bg));
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-container {
            max-width: 1000px;
            width: 100%;
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-bg));
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px var(--shadow-color),
                        0 0 0 1px var(--border-color);
            border: 1px solid var(--border-color);
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary-dark), var(--card-bg));
            color: var(--text-color);
            padding: 1.5rem 2rem;
            text-align: center;
            border-bottom: 2px solid var(--accent-purple);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.1), transparent 70%);
            z-index: 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            margin-right: 15px;
            color: var(--accent-cyan);
            text-shadow: 0 0 15px var(--accent-cyan);
        }
        
        .logo-text {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(to right, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }
        
        .logo-slogan {
            font-size: 1rem;
            font-weight: 300;
            opacity: 0.8;
            margin-top: 5px;
            color: var(--accent-cyan);
        }
        
        .theme-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 2;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .theme-toggle:hover {
            transform: rotate(15deg);
            box-shadow: 0 0 15px var(--accent-purple);
        }
        
        .content {
            padding: 2rem;
        }
        
        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            font-weight: 700;
            font-size: 1.8rem;
            position: relative;
        }
        
        h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, var(--accent-blue), var(--accent-purple));
            border-radius: 3px;
        }
        
        h2 {
            color: var(--accent-cyan);
            margin-top: 2rem;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            position: relative;
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }
        
        h2::after {
            content: "";
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, var(--accent-purple), var(--accent-magenta));
            border-radius: 3px;
        }
        
        .input-section {
            margin-bottom: 2rem;
            padding: 1.8rem;
            border-radius: 15px;
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 5px 15px var(--shadow-color);
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.15), rgba(0, 200, 160, 0.15));
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }
        
        label {
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        
        input, select {
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s;
            background-color: var(--result-bg);
            color: var(--text-color);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        input:focus, select:focus {
            border-color: var(--accent-purple);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3),
                        inset 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg);
        }

        input[readonly] {
            background-color: rgba(0,0,0,0.1);
            cursor: default;
            opacity: 0.7;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
            background-color: var(--result-bg);
            padding: 12px 18px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }
        
        .radio-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: normal;
            margin-right: 15px;
        }
        
        .radio-group input[type="radio"] {
            display: none;
        }
        
        .radio-group input[type="radio"] + label:before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
            border: 2px solid var(--accent-purple);
            vertical-align: middle;
            transition: all 0.2s;
            background-color: transparent;
        }
        
        .radio-group input[type="radio"]:checked + label:before {
            background-color: var(--accent-purple);
            box-shadow: inset 0 0 0 4px var(--card-bg), 0 0 10px var(--accent-purple);
        }
        
        .user-type-section {
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.1), rgba(0, 200, 160, 0.1));
            padding: 1.8rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent-purple);
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        button {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
            color: var(--primary-foreground);
            border: none;
            padding: 16px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin: 1.5rem 0;
            width: 100%;
            max-width: 320px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(253, 90, 247, 0.6);
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .result-section {
            margin-top: 2rem;
            padding: 1.8rem;
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.15), rgba(0, 200, 160, 0.15));
            border-radius: 15px;
            border-left: 4px solid var(--accent-purple);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }
        
        .result-item {
            padding: 16px;
            background-color: var(--result-bg);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }
        
        .result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
        }
        
        .highlight {
            font-weight: bold;
            color: var(--accent-cyan);
            font-size: 1.2rem;
            text-shadow: 0 0 8px rgba(90, 253, 247, 0.5);
        }
        
        .chart-container {
            margin-top: 2rem;
            height: 420px;
            background: var(--result-bg);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        #month-input-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
            margin-bottom: 1.8rem;
        }
        
        .panel-config, .tarifa-section {
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.15), rgba(0, 200, 160, 0.15));
            padding: 1.8rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background: var(--card-bg);
            color: var(--text-color);
            text-align: center;
            border-radius: 10px;
            padding: 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
            border: 1px solid var(--accent-purple);
            box-shadow: 0 5px 15px var(--shadow-color);
            backdrop-filter: blur(10px);
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .roi-section {
            background: linear-gradient(145deg, rgba(253, 90, 247, 0.15), rgba(0, 200, 160, 0.15));
            margin-top: 1.8rem;
            padding: 1.8rem;
            border-radius: 15px;
            border-left: 4px solid var(--accent-magenta);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .roi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }
        
        .roi-item {
            padding: 16px;
            background-color: var(--result-bg);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            border: 1px solid rgba(253, 90, 247, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .roi-highlight {
            font-weight: bold;
            color: var(--accent-magenta);
            font-size: 1.3rem;
            text-shadow: 0 0 8px rgba(253, 90, 247, 0.5);
        }
        
        .currency-switcher {
            display: flex;
            align-items: center;
            margin-bottom: 1.8rem;
            background: var(--result-bg);
            padding: 14px;
            border-radius: 12px;
            justify-content: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
        }
        
        .currency-switcher label {
            margin: 0 15px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 65px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, var(--accent-purple), var(--accent-blue));
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        
        input:checked + .slider {
            background: linear-gradient(to right, var(--accent-magenta), var(--accent-blue));
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--footer-text);
            font-size: 0.9rem;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        
        .tech-section, .common-section, .main-content {
            display: none;
        }
        
        .main-content { animation: fadeIn 0.8s ease-out; }
        .app-section { animation: fadeIn 0.5s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .recommended-system {
            background: linear-gradient(145deg, rgba(90, 253, 159, 0.1), rgba(90, 253, 247, 0.1));
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 18px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .strings-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }
        
        .user-type-title, .info-icon, .strings-info {
            color: var(--accent-cyan);
        }
        .user-type-title { margin-bottom: 15px; font-size: 1.2rem; }
        .info-icon { font-size: 1.2rem; margin-left: 5px; }
        .strings-info { font-size: 0.9rem; margin-top: 8px; display: block; }
        
        .glow { text-shadow: 0 0 10px var(--accent-cyan), 0 0 20px var(--accent-purple); }
        
        .interactive-card {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .interactive-card::before {
            content: "";
            position: absolute;
            left: var(--x);
            top: var(--y);
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.4), transparent 60%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            z-index: -1;
            pointer-events: none;
        }

        .interactive-card:hover::before { opacity: 1; }

        /* --- ESTILOS PARA LA MODAL DE ANÁLISIS IA --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--primary-bg);
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px var(--shadow-color);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .modal-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        .modal-content strong {
            color: var(--accent-cyan);
        }
        .modal-close-btn {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            margin-top: 1.5rem;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-magenta));
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-bottom-color: var(--accent-cyan);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 20px auto;
            display: block;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-content h4 {
            color: var(--accent-cyan);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .analysis-content ul {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .analysis-content li {
            margin-bottom: 0.5rem;
        }
        
        /* Nuevos estilos para el slider */
        .slider-container {
            margin-top: 15px;
            padding: 10px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            margin-top: 5px;
        }
        
        .pr-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #ff4d4d, #ffcc00, #00cc00);
            outline: none;
            -webkit-appearance: none;
        }
        
        .pr-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(90, 253, 247, 0.8);
            border: 2px solid white;
        }
        
        .pr-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-cyan);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(90, 253, 247, 0.8);
            border: 2px solid white;
        }
        
        .pr-value-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 10px;
            color: var(--accent-cyan);
            text-shadow: 0 0 8px rgba(90, 253, 247, 0.5);
        }
        
        @media (max-width: 768px) {
            #month-input-container, .result-grid, .roi-grid, .strings-config {
                grid-template-columns: 1fr;
            }
            .header { padding: 1.2rem; flex-direction: column; gap: 15px; }
            .logo-text { font-size: 1.8rem; }
            .content { padding: 1.5rem; }
        }
        
        @media (max-width: 480px) {
            body { padding: 10px; }
            .app-container { border-radius: 15px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">☀️</div>
                <div>
                    <div class="logo-text">SUPER SOLAR</div>
                    <div class="logo-slogan">Calculadora Fotovoltaica Avanzada Premium</div>
                </div>
            </div>
            <div class="theme-toggle" id="theme-toggle">
                <span id="theme-icon">🌙</span>
            </div>
        </div>
        
        <div class="content">
            <h1 class="glow-effect">Configuración de Sistema Solar</h1>
            
            <div class="user-type-section app-section interactive-card">
                <h2 class="glow-effect" style="margin-top: 0; border: none;">Seleccione su tipo de usuario</h2>
                <div class="radio-group">
                    <input type="radio" id="usuario-comun" name="tipo-usuario" value="comun" onchange="toggleUserType()">
                    <label for="usuario-comun">Usuario Común</label>
                    <input type="radio" id="usuario-tecnico" name="tipo-usuario" value="tecnico" onchange="toggleUserType()">
                    <label for="usuario-tecnico">Usuario Técnico</label>
                </div>
                <p style="margin-top: 20px; color: var(--accent-cyan);">
                    Seleccione una opción para continuar con la configuración del sistema
                </p>
            </div>
            
            <div class="main-content">
                <div class="interactive-card" style="padding: 1.8rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h2 class="glow-effect" style="margin-top: 0;">1. Moneda</h2>
                    <div class="currency-switcher">
                        <span>MXN</span>
                        <label class="switch">
                            <input type="checkbox" id="currency-toggle" onchange="toggleCurrency()">
                            <span class="slider"></span>
                        </label>
                        <span>USD</span>
                    </div>
                </div>
                
                <div class="tarifa-section interactive-card">
                    <h2 class="glow-effect" style="margin-top: 0;">2. Configuración de Tarifa CFE</h2>
                    <div class="input-group">
                        <label class="tooltip">Periodo del Contrato<span class="tooltiptext">Seleccione si su recibo de CFE es mensual o bimestral</span></label>
                        <div class="radio-group">
                            <input type="radio" id="contrato-mensual" name="tipo-contrato" value="mensual" checked onchange="renderConsumptionInputs()">
                            <label for="contrato-mensual">Mensual</label>
                            <input type="radio" id="contrato-bimestral" name="tipo-contrato" value="bimestral" onchange="renderConsumptionInputs()">
                            <label for="contrato-bimestral">Bimestral</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="tipo-tarifa" class="tooltip">Tipo de Tarifa CFE<span class="tooltiptext">Seleccione la tarifa eléctrica actual</span></label>
                        <select id="tipo-tarifa" onchange="calcularGeneracion()">
                            <optgroup label="Tarifas Domésticas (Residencial)">
                                <option value="1">Tarifa 1</option><option value="1A">Tarifa 1A</option><option value="1B">Tarifa 1B</option><option value="1C">Tarifa 1C</option><option value="1D" selected>Tarifa 1D</option><option value="1E">Tarifa 1E</option><option value="1F">Tarifa 1F</option><option value="DAC">Tarifa DAC</option>
                            </optgroup>
                            <optgroup label="Tarifas Comerciales e Industriales">
                                <option value="PDBT">PDBT</option><option value="GDBT">GDBT</option><option value="GDMTO">GDMTO</option><option value="GDMTH">GDMTH</option><option value="DIST">DIST</option><option value="DIT">DIT</option><option value="RABT">RABT</option><option value="RAMT">RAMT</option><option value="APBT">APBT</option><option value="APMT">APMT</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="input-section interactive-card">
                    <h2 class="glow-effect" style="margin-top: 0;">3. Consumo Energético</h2>
                    <p>Ingrese el consumo en kWh por periodo:</p>
                    <div id="month-input-container"></div>
                </div>
                
                <div id="consumo-result" class="result-section interactive-card" style="display: none;">
                    <h3 class="glow-effect">Resumen de Consumo</h3>
                    <div class="result-grid">
                        <div class="result-item"><span>Consumo anual total:</span><span id="consumo-anual" class="highlight"></span></div>
                        <div class="result-item"><span>Consumo mensual promedio:</span><span id="consumo-mensual"></span></div>
                        <div class="result-item"><span>Consumo diario promedio:</span><span id="consumo-diario"></span></div>
                        <div class="result-item"><span>Consumo por hora promedio:</span><span id="consumo-hora"></span></div>
                    </div>
                </div>
                
                <div class="panel-config interactive-card">
                    <h2 class="glow-effect" style="margin-top: 0;">4. Configuración del Sistema Solar</h2>
                    <div id="common-config" class="common-section">
                        <div class="recommended-system"><p>Recomendamos un sistema de <span id="recommended-size" class="highlight glow">0 kWp</span></p></div>
                        <div class="input-group"><label for="system-size">Tamaño del Sistema (kWp)</label><input type="number" id="system-size" min="0.1" step="0.1" value="0" oninput="calcularGeneracion()"></div>
                        <div class="input-group"><label for="panel-power-common">Potencia de los Paneles (W)</label><select id="panel-power-common" onchange="calcularGeneracion()"><option value="450">450 W</option><option value="500">500 W</option><option value="550" selected>550 W</option><option value="600">600 W</option></select></div>
                    </div>
                    <div id="tech-config" class="tech-section">
                        <div class="input-group"><label for="panel-count">Número de Paneles</label><input type="number" id="panel-count" min="1" value="10" oninput="calcularGeneracion(); updateInverterSize()" step="1" pattern="\d*"></div>
                        <div class="input-group"><label for="panel-power">Potencia de Panel (W)</label><select id="panel-power" onchange="calcularGeneracion(); updateInverterSize()"><option value="450">450 W</option><option value="500">500 W</option><option value="550" selected>550 W</option><option value="600">600 W</option></select></div>
                        <div class="strings-config">
                            <div class="input-group"><label for="inverter-size">Tamaño del Inversor (kW)</label><input type="number" id="inverter-size" min="1" max="100" value="5" step="0.1" readonly></div>
                            <div class="input-group"><label for="string-count"># de Strings <span class="tooltip">ⓘ<span class="tooltiptext">Cada string mejora la eficiencia y aumenta el costo.</span></span></label><input type="number" id="string-count" min="1" max="20" value="2" oninput="calcularGeneracion()" step="1" pattern="\d*"></div>
                        </div>
                    </div>
                    <div class="input-group"><label for="location">Zona Geográfica</label><select id="location" onchange="calcularGeneracion(); updateRecommendation()"><option value="norte">Norte</option><option value="centro" selected>Centro</option><option value="sur">Sur</option><option value="muy_soleada">Muy Soleada</option></select></div>
                    
                    <!-- Nuevo slider para Performance Ratio -->
                    <div class="input-group">
                        <label for="performance-ratio-slider">Performance Ratio (PR)</label>
                        <div class="slider-container">
                            <input 
                                type="range" 
                                id="performance-ratio-slider" 
                                class="pr-slider"
                                min="1" 
                                max="100" 
                                value="85" 
                                oninput="updatePerformanceRatio(this.value)"
                            >
                            <div class="slider-labels">
                                <span>1%</span>
                                <span>50%</span>
                                <span>100%</span>
                            </div>
                            <div class="pr-value-display" id="pr-value">85%</div>
                        </div>
                    </div>
                    
                    <div class="input-group"><label for="cost-per-kw">Costo por kWp (Fijo)</label><input type="text" id="cost-per-kw" readonly></div>
                </div>
                
                <div id="generacion-result" class="result-section interactive-card" style="display: none;">
                    <h3 class="glow-effect">Resumen de Generación y ROI</h3>
                    <div class="result-grid">
                        <div class="result-item"><span>Potencia del sistema:</span><span id="potencia-sistema" class="highlight"></span></div>
                        <div class="result-item"><span>Generación anual:</span><span id="generacion-anual" class="highlight"></span></div>
                        <div class="result-item"><span>Autosuficiencia:</span><span id="autosuficiencia" class="highlight"></span></div>
                        <div class="result-item"><span>Costo del sistema:</span><span id="costo-sistema-roi" class="roi-highlight"></span></div>
                    </div>
                     <div class="roi-section">
                        <h3 class="glow-effect">Análisis de ROI</h3>
                        <div class="roi-grid">
                            <div class="roi-item"><span>Costo anual CFE:</span><span id="costo-cfe" class="roi-highlight"></span></div>
                            <div class="roi-item"><span>Ahorro anual:</span><span id="ahorro-anual" class="roi-highlight"></span></div>
                            <div class="roi-item"><span>Retorno de inversión:</span><span id="retorno-inversion" class="roi-highlight"></span></div>
                        </div>
                    </div>
                </div>
                
                <h2 class="glow-effect">5. Visualización de Resultados</h2>
                <button onclick="generarComparativa()">Generar Gráficas</button>
                <button id="gemini-analysis-btn" onclick="getEnergyAnalysis()" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue)); display: none;">✨ Obtener Análisis Energético</button>
                
                <div id="comparison-result" style="display: none;">
                    <div class="chart-container interactive-card"><canvas id="comparisonChart"></canvas></div>
                    <div class="chart-container interactive-card" id="roi-chart-container" style="margin-top: 2rem; display: none;"><canvas id="roiChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 Super Solar - Todos los derechos reservados</p>
            <p>Datos de irradiancia solar cortesía de NASA POWER</p>
            <p>Creado por David Bustillos Chavez</p>
        </div>
    </div>

    <div id="analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>✨ Análisis Energético Inteligente</h3>
            <div id="analysis-result"><div class="loader"></div></div>
            <button class="modal-close-btn" onclick="closeAnalysisModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES Y VARIABLES GLOBALES ---
        let consumoMensual = new Array(12).fill(0);
        let generacionMensual = new Array(12).fill(0);
        let currentCurrency = 'MXN';
        let isTechnicalUser = false;
        let comparisonChartInstance, roiChartInstance;
        
        const COST_PER_KWP_USD = 1000;
        const USD_TO_MXN_RATE = 18.00;
        const COST_PER_KWP_MXN = COST_PER_KWP_USD * USD_TO_MXN_RATE;
        const costoPorString = 800;
        const eficienciaPorString = 0.015;
        
        const tarifasCFE = {'1':0.98,'1A':1.1,'1B':1.2,'1C':1.8,'1D':2.1,'1E':2.5,'1F':2.8,'DAC':4.5,'PDBT':2.8,'GDBT':2.5,'GDMTO':2.2,'GDMTH':2,'DIST':1.8,'DIT':1.6,'RABT':1.5,'RAMT':1.4,'APBT':1.2,'APMT':1.1};
        const nasaIrradianceData = {norte:[4.1,5,6.2,7.1,7.6,7.3,6.4,6.2,5.9,5.2,4.3,3.8],centro:[4.9,5.7,6.3,6.5,6.2,5.5,5.5,5.6,5.1,5.1,5,4.6],sur:[5,5.8,6.5,6.4,5.7,4.9,5.2,5.3,4.8,4.8,4.9,4.7],muy_soleada:[4.4,5.3,6.5,7.5,8.2,8.4,7.3,7,6.6,5.8,4.7,4]};
        
        // --- FUNCIONES DE LA APLICACIÓN ---
        function updateCostPerKwpDisplay() {
            const costInput = document.getElementById('cost-per-kw');
            const costToDisplay = (currentCurrency === 'USD') ? COST_PER_KWP_USD : COST_PER_KWP_MXN;
            costInput.value = new Intl.NumberFormat(currentCurrency === 'USD' ? 'en-US' : 'es-MX', {
                style: 'currency', currency: currentCurrency, minimumFractionDigits: 0
            }).format(costToDisplay);
        }
        
        function getPerformanceRatio() {
            return parseInt(document.getElementById("performance-ratio-slider").value) / 100;
        }

        function updatePerformanceRatio(value) {
            document.getElementById("pr-value").textContent = value + "%";
            calcularGeneracion();
        }

        function updateInverterSize() {
            if(isTechnicalUser){
                const panelCount = parseInt(document.getElementById("panel-count").value) || 0;
                const panelPower = parseInt(document.getElementById("panel-power").value) || 0;
                const systemPowerKW = (panelCount * panelPower) / 1000;
                document.getElementById("inverter-size").value = Math.max(1, Math.round(1.1 * systemPowerKW * 10) / 10).toFixed(1);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute("data-theme");
            const newTheme = "dark" === currentTheme ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", newTheme);
            document.getElementById("theme-icon").textContent = "dark" === newTheme ? "🌙" : "☀️";
            localStorage.setItem("theme", newTheme);
        }

        function toggleUserType() {
            const selected = document.querySelector('input[name="tipo-usuario"]:checked');
            if(selected){
                isTechnicalUser = "tecnico" === selected.value;
                const techSection = document.getElementById("tech-config");
                const commonSection = document.getElementById("common-config");
                document.querySelector(".main-content").style.display = "block";
                if(isTechnicalUser){
                    techSection.style.display = "block";
                    commonSection.style.display = "none";
                    updateInverterSize();
                } else {
                    techSection.style.display = "none";
                    commonSection.style.display = "block";
                    updateRecommendation();
                }
                calcularGeneracion();
                generarComparativa();
            }
        }

        function updateRecommendation() {
            if(!isTechnicalUser){
                const consumoTotal = consumoMensual.reduce((a, b) => a + b, 0);
                const region = document.getElementById("location").value;
                if(consumoTotal > 0){
                    const promedioIrradiancia = nasaIrradianceData[region].reduce((a, b) => a + b, 0) / 12;
                    const consumoDiarioPromedio = consumoTotal / 365;
                    const systemSize = (consumoDiarioPromedio * 1.2) / promedioIrradiancia;
                    document.getElementById("recommended-size").textContent = systemSize.toFixed(1) + " kWp";
                    document.getElementById("system-size").value = systemSize.toFixed(1);
                }
            }
        }

        function renderConsumptionInputs() {
            const container = document.getElementById("month-input-container");
            const tipoContrato = document.querySelector('input[name="tipo-contrato"]:checked').value;
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            let html = "";
            if("mensual" === tipoContrato){
                container.style.gridTemplateColumns = "repeat(3, 1fr)";
                for(let i = 0; i < 12; i++) {
                    html += `<div class="input-group"><label for="mes-${i}">${meses[i]}:</label><input type="number" id="mes-${i}" data-month-index="${i}" min="0" step="0.1" placeholder="kWh" oninput="calcularConsumoAnual()"></div>`;
                }
            } else {
                container.style.gridTemplateColumns = "repeat(2, 1fr)";
                for(let i = 0; i < 12; i += 2) {
                    html += `<div class="input-group"><label for="bim-${i / 2}">${meses[i]} - ${meses[i + 1]}:</label><input type="number" id="bim-${i / 2}" data-month-indices="${i},${i + 1}" min="0" step="0.1" placeholder="kWh" oninput="calcularConsumoAnual()"></div>`;
                }
            }
            container.innerHTML = html;
            calcularConsumoAnual();
        }

        function calcularConsumoAnual() {
            consumoMensual.fill(0);
            let totalAnual = 0;
            const tipoContrato = document.querySelector('input[name="tipo-contrato"]:checked').value;
            if("mensual" === tipoContrato){
                for(let i = 0; i < 12; i++){
                    const valor = parseFloat(document.getElementById(`mes-${i}`).value) || 0;
                    consumoMensual[i] = valor;
                    totalAnual += valor;
                }
            } else {
                for(let i = 0; i < 6; i++){
                    const valor = parseFloat(document.getElementById(`bim-${i}`).value) || 0;
                    totalAnual += valor;
                    consumoMensual[i * 2] = valor / 2;
                    consumoMensual[i * 2 + 1] = valor / 2;
                }
            }
            const resultadoElemento = document.getElementById("consumo-result");
            if(totalAnual === 0){
                resultadoElemento.style.display = "none";
            } else {
                document.getElementById("consumo-anual").textContent = `${totalAnual.toFixed(1)} kWh`;
                document.getElementById("consumo-mensual").textContent = `${(totalAnual / 12).toFixed(1)} kWh/mes`;
                document.getElementById("consumo-diario").textContent = `${(totalAnual / 365).toFixed(1)} kWh/día`;
                document.getElementById("consumo-hora").textContent = `${(totalAnual / 365 / 24).toFixed(2)} kWh/hora`;
                resultadoElemento.style.display = "block";
                if(!isTechnicalUser) {
                    updateRecommendation();
                }
            }
            if(totalAnual > 0){
                calcularGeneracion();
                generarComparativa();
            }
        }
        
        function calcularGeneracion() {
            const consumoTotal = consumoMensual.reduce((a, b) => a + b, 0);
            if (consumoTotal === 0) {
                document.getElementById("generacion-result").style.display = 'none';
                document.getElementById("gemini-analysis-btn").style.display = 'none';
                return;
            }
            let systemPowerKW = 0;
            const region = document.getElementById("location").value;
            const performanceRatio = getPerformanceRatio();
            const tipoTarifa = document.getElementById("tipo-tarifa").value;
            const tarifaCosto = tarifasCFE[tipoTarifa] || 2.0;
            let stringEfficiencyFactor = 1;
            
            if (isTechnicalUser) {
                const panelCount = parseInt(document.getElementById("panel-count").value) || 0;
                const panelPowerW = parseInt(document.getElementById("panel-power").value) || 0;
                systemPowerKW = panelCount * panelPowerW / 1000;
                const numStrings = parseInt(document.getElementById("string-count").value) || 0;
                stringEfficiencyFactor = 1 + (numStrings * eficienciaPorString);
            } else {
                systemPowerKW = parseFloat(document.getElementById("system-size").value) || 0;
                const panelPowerW = parseInt(document.getElementById("panel-power-common").value) || 0;
                document.getElementById("panel-count").value = Math.round(systemPowerKW * 1000 / panelPowerW);
            }

            if (systemPowerKW === 0) return;
            
            const irradianceArray = nasaIrradianceData[region];
            const diasPorMes = [31, 28.25, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            generacionMensual = diasPorMes.map((dias, i) => systemPowerKW * irradianceArray[i] * dias * performanceRatio * stringEfficiencyFactor);
            const generacionAnual = generacionMensual.reduce((sum, val) => sum + val, 0);
            
            let systemCost = systemPowerKW * COST_PER_KWP_MXN;
            if (isTechnicalUser) {
                systemCost += (parseInt(document.getElementById("string-count").value) || 0) * costoPorString;
            }
            
            const autosuficiencia = Math.min(100, (generacionAnual / consumoTotal) * 100);
            const costoCFEAnual = consumoTotal * tarifaCosto;
            const ahorroAnual = Math.min(generacionAnual, consumoTotal) * tarifaCosto;
            const retornoInversion = (ahorroAnual > 0) ? (systemCost / ahorroAnual) : Infinity;
            
            document.getElementById("potencia-sistema").textContent = `${systemPowerKW.toFixed(2)} kWp`;
            document.getElementById("generacion-anual").textContent = `${generacionAnual.toFixed(1)} kWh`;
            document.getElementById("autosuficiencia").textContent = `${autosuficiencia.toFixed(1)}%`;
            document.getElementById("costo-sistema-roi").textContent = formatCurrency(systemCost);
            document.getElementById("costo-cfe").textContent = formatCurrency(costoCFEAnual);
            document.getElementById("ahorro-anual").textContent = formatCurrency(ahorroAnual);
            document.getElementById("retorno-inversion").textContent = isFinite(retornoInversion) ? `${retornoInversion.toFixed(1)} años` : "N/A (sin ahorro)";
            document.getElementById("generacion-result").style.display = "block";
            document.getElementById("gemini-analysis-btn").style.display = 'block';
        }
        
        function generarComparativa() {
            const consumoTotal = consumoMensual.reduce((a, b) => a + b, 0);
            if (consumoTotal === 0) {
                document.getElementById("comparison-result").style.display = "none";
                document.getElementById("roi-chart-container").style.display = "none";
                return;
            }
            const tipoContrato = document.querySelector('input[name="tipo-contrato"]:checked').value;
            let labels, consumoGrafica = [], generacionGrafica = [];
            if ("mensual" === tipoContrato) {
                labels = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                consumoGrafica = [...consumoMensual];
                generacionGrafica = [...generacionMensual];
            } else {
                labels = ["Ene-Feb", "Mar-Abr", "May-Jun", "Jul-Ago", "Sep-Oct", "Nov-Dic"];
                for (let i = 0; i < 12; i += 2) {
                    consumoGrafica.push(consumoMensual[i] + consumoMensual[i + 1]);
                    generacionGrafica.push(generacionMensual[i] + generacionMensual[i + 1]);
                }
            }
            const ctx = document.getElementById("comparisonChart").getContext("2d");
            if(comparisonChartInstance) comparisonChartInstance.destroy();
            comparisonChartInstance = new Chart(ctx, {
                type: "bar",
                data: { 
                    labels: labels, 
                    datasets: [
                        { 
                            label: "Consumo (kWh)", 
                            data: consumoGrafica, 
                            backgroundColor: "rgba(253, 90, 247, 0.7)", 
                            borderColor: "rgba(253, 90, 247, 1)", 
                            borderWidth: 1 
                        }, 
                        { 
                            label: "Generación Solar (kWh)", 
                            data: generacionGrafica, 
                            backgroundColor: "rgba(0, 200, 160, 0.7)", 
                            borderColor: "rgba(0, 200, 160, 1)", 
                            borderWidth: 1 
                        }
                    ] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: "kWh", color: "var(--text-color)" }, 
                            ticks: { color: "var(--text-color)" }, 
                            grid: { color: "rgba(224, 224, 255, 0.1)" } 
                        }, 
                        x: { 
                            title: { display: true, text: "Periodo", color: "var(--text-color)" }, 
                            ticks: { color: "var(--text-color)" }, 
                            grid: { color: "rgba(224, 224, 255, 0.1)" } 
                        } 
                    }, 
                    plugins: { 
                        title: { 
                            display: true, 
                            text: "Comparativa Anual: Consumo vs Generación Solar", 
                            font: { size: 16 }, 
                            color: "var(--text-color)" 
                        }, 
                        legend: { 
                            labels: { color: "var(--text-color)" } 
                        }, 
                        tooltip: { 
                            callbacks: { 
                                label: e => `${e.dataset.label}: ${e.raw.toFixed(1)} kWh` 
                            } 
                        } 
                    } 
                } 
            });
            document.getElementById("comparison-result").style.display = "block";
            generarGraficaROI();
        }

        function generarGraficaROI() {
            const consumoTotal = consumoMensual.reduce((a, b) => a + b, 0);
            const generacionAnual = generacionMensual.reduce((sum, val) => sum + val, 0);
            let systemPowerKW = isTechnicalUser ? (parseInt(document.getElementById("panel-count").value) || 0) * (parseInt(document.getElementById("panel-power").value) || 0) / 1000 : parseFloat(document.getElementById("system-size").value) || 0;
            let systemCost = systemPowerKW * COST_PER_KWP_MXN;
            if (isTechnicalUser) {
                systemCost += (parseInt(document.getElementById("string-count").value) || 0) * costoPorString;
            }
            const tipoTarifa = document.getElementById("tipo-tarifa").value;
            const tarifaCosto = tarifasCFE[tipoTarifa] || 2.0;
            const ahorroAnual = Math.min(generacionAnual, consumoTotal) * tarifaCosto;
            const roiChartContainer = document.getElementById("roi-chart-container");
            if (systemCost <= 0 || ahorroAnual <= 0) {
                roiChartContainer.style.display = "none";
                return;
            }
            roiChartContainer.style.display = "block";
            const startYear = new Date().getFullYear();
            const years = Array.from({ length: 26 }, (v, i) => startYear + i);
            let cumulativeSavings = 0;
            const investmentData = years.map(() => {
                const balance = -systemCost + cumulativeSavings;
                cumulativeSavings += ahorroAnual;
                return balance;
            });
            const ctx = document.getElementById("roiChart").getContext("2d");
            if(roiChartInstance) roiChartInstance.destroy();
            roiChartInstance = new Chart(ctx, {
                type: "line",
                data: { 
                    labels: years, 
                    datasets: [
                        { 
                            label: "Retorno de Inversión", 
                            data: investmentData, 
                            fill: true, 
                            borderColor: "rgba(37, 99, 235, 1)", 
                            backgroundColor: "rgba(37, 99, 235, 0.2)", 
                            tension: .2, 
                            pointBackgroundColor: e => e.dataset.data[e.dataIndex] >= 0 ? "var(--accent-cyan)" : "var(--accent-magenta)", 
                            pointRadius: 4, 
                            pointHoverRadius: 7 
                        }
                    ] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: false, 
                            title: { display: true, text: `Balance Acumulado (${currentCurrency})`, color: "var(--text-color)" }, 
                            ticks: { color: "var(--text-color)", callback: e => formatCurrency(e) }, 
                            grid: { color: "rgba(224, 224, 255, 0.1)" } 
                        }, 
                        x: { 
                            title: { display: true, text: "Año", color: "var(--text-color)" }, 
                            ticks: { color: "var(--text-color)" }, 
                            grid: { color: "rgba(224, 224, 255, 0.1)" } 
                        } 
                    }, 
                    plugins: { 
                        title: { 
                            display: true, 
                            text: "Proyección de Ahorro y Retorno de Inversión (25 años)", 
                            font: { size: 16 }, 
                            color: "var(--text-color)" 
                        }, 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: e => `${e.label}: ${formatCurrency(e.parsed.y)}` 
                            } 
                        } 
                    } 
                } 
            });
        }
        
        function formatCurrency(amountInMxn) {
            const currencyCode = currentCurrency === 'USD' ? 'USD' : 'MXN';
            const locale = currentCurrency === 'USD' ? 'en-US' : 'es-MX';
            const finalAmount = currentCurrency === 'USD' ? amountInMxn / USD_TO_MXN_RATE : amountInMxn;
            return new Intl.NumberFormat(locale, { style: 'currency', currency: currencyCode, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(finalAmount);
        }

        function toggleCurrency() {
            currentCurrency = document.getElementById('currency-toggle').checked ? 'USD' : 'MXN';
            updateCostPerKwpDisplay();
            if (document.getElementById("generacion-result").style.display !== 'none') {
                calcularGeneracion();
                generarComparativa();
            }
        }

        function openAnalysisModal(){document.getElementById("analysis-modal").classList.add("visible")}
        function closeAnalysisModal(){document.getElementById("analysis-modal").classList.remove("visible")}
        
        async function getEnergyAnalysis() {
            openAnalysisModal();
            const resultDiv = document.getElementById("analysis-result");
            resultDiv.innerHTML = '<div class="loader"></div>';
            
            // Simulamos un tiempo de carga
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            try {
                // Obtenemos los datos necesarios
                const consumoAnual = parseFloat(document.getElementById("consumo-anual").textContent.split(' ')[0]);
                const generacionAnual = parseFloat(document.getElementById("generacion-anual").textContent.split(' ')[0]);
                const potenciaSistema = document.getElementById("potencia-sistema").textContent;
                const costoSistema = document.getElementById("costo-sistema-roi").textContent;
                const ahorroAnual = document.getElementById("ahorro-anual").textContent;
                const retornoInversion = document.getElementById("retorno-inversion").textContent;
                const autosuficiencia = document.getElementById("autosuficiencia").textContent;
                const locationSelect = document.getElementById("location");
                const zonaGeografica = locationSelect.options[locationSelect.selectedIndex].text;
                const prValue = document.getElementById("performance-ratio-slider").value;
                
                // Factor de emisiones en México (kg CO2 por kWh)
                const factorCO2 = 0.467;
                const reduccionCO2 = (Math.min(consumoAnual, generacionAnual) * factorCO2).toFixed(0);
                const arbolesEquivalentes = Math.round(reduccionCO2 / 20); // Cada árbol absorbe ~20kg CO2 al año
                
                // Consejos según la zona
                let consejos = "";
                switch(locationSelect.value) {
                    case "norte":
                        consejos = `
                            <li>Aproveche las altas horas de sol con paneles de alta eficiencia</li>
                            <li>Proteja sus paneles de tormentas de arena con limpieza regular</li>
                            <li>Considere inclinación óptima para captar máximo sol en invierno</li>
                        `;
                        break;
                    case "centro":
                        consejos = `
                            <li>Oriente los paneles hacia el sur con inclinación de 20°</li>
                            <li>Realice mantenimiento preventivo en temporada de lluvias</li>
                            <li>Considere microinversores para mayor eficiencia en zonas con sombras parciales</li>
                        `;
                        break;
                    case "sur":
                        consejos = `
                            <li>Instale paneles resistentes a alta humedad</li>
                            <li>Limpie frecuentemente los paneles por la alta precipitación</li>
                            <li>Aproveche la radiación difusa con tecnología de células avanzadas</li>
                        `;
                        break;
                    case "muy_soleada":
                        consejos = `
                            <li>Use paneles con bajo coeficiente de temperatura</li>
                            <li>Instale sistema de refrigeración pasiva para paneles</li>
                            <li>Considere seguidores solares para maximizar la captación</li>
                        `;
                        break;
                }
                
                // Generamos el análisis
                const analysisHTML = `
                    <div class="analysis-content">
                        <h4>Análisis Financiero</h4>
                        <p>Con un consumo anual de <strong>${consumoAnual} kWh</strong> y una generación solar de <strong>${generacionAnual} kWh</strong>, su sistema de <strong>${potenciaSistema}</strong> cubre aproximadamente <strong>${autosuficiencia}</strong> de su consumo eléctrico.</p>
                        <p>El costo de su sistema fue de <strong>${costoSistema}</strong> y le genera un ahorro anual estimado de <strong>${ahorroAnual}</strong>. Esto representa un retorno de inversión en <strong>${retornoInversion}</strong>, mejor que muchas inversiones tradicionales.</p>
                        
                        <h4>Impacto Ambiental</h4>
                        <p>Su sistema solar evitará la emisión de aproximadamente <strong>${reduccionCO2} kg de CO₂</strong> anualmente, equivalente a plantar <strong>${arbolesEquivalentes} árboles</strong>.</p>
                        
                        <h4>Eficiencia del Sistema</h4>
                        <p>Su sistema está configurado con un Performance Ratio de <strong>${prValue}%</strong>. Este valor representa la eficiencia global de su instalación solar.</p>
                        
                        <h4>Recomendaciones para ${zonaGeografica}</h4>
                        <ul>${consejos}</ul>
                        
                        <h4>Conclusión</h4>
                        <p>Su inversión en energía solar no solo reduce sus costos eléctricos de manera significativa, sino que también contribuye activamente a la protección del medio ambiente. ¡Felicitaciones por unirte a la revolución solar!</p>
                    </div>
                `;
                
                resultDiv.innerHTML = analysisHTML;
                
            } catch (error) {
                console.error("Error en análisis:", error);
                resultDiv.innerHTML = `
                    <p>Ocurrió un error al generar el análisis. Por favor, intente de nuevo.</p>
                    <p><small>${error.message}</small></p>
                `;
            }
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            const savedTheme = localStorage.getItem("theme") || "dark";
            document.documentElement.setAttribute("data-theme", savedTheme);
            document.getElementById("theme-icon").textContent = "dark" === savedTheme ? "🌙" : "☀️";
            document.getElementById("theme-toggle").addEventListener("click", toggleTheme);
            updateCostPerKwpDisplay();
            renderConsumptionInputs();
            document.getElementById("panel-count").addEventListener("input", e => { e.target.value = e.target.value.replace(/[^0-9]/g, "") });
            document.getElementById("string-count").addEventListener("input", e => { e.target.value = e.target.value.replace(/[^0-9]/g, "") });
            document.querySelectorAll(".interactive-card").forEach(e => {
                e.addEventListener("mousemove", t => {
                    const n = e.getBoundingClientRect(), o = t.clientX - n.left, a = t.clientY - n.top;
                    e.style.setProperty("--x", `${o}px`);
                    e.style.setProperty("--y", `${a}px`);
                });
            });
        });
    </script>
</body>
</html>
